var et=Object.defineProperty;var K=i=>{throw TypeError(i)};var st=(i,t,e)=>t in i?et(i,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):i[t]=e;var n=(i,t,e)=>st(i,typeof t!="symbol"?t+"":t,e),it=(i,t,e)=>t.has(i)||K("Cannot "+e);var I=(i,t,e)=>t.has(i)?K("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(i):t.set(i,e);var y=(i,t,e)=>(it(i,t,"access private method"),e);import"./modulepreload-polyfill-B5Qt9EMX.js";/* empty css              */var Y,X;class ht{constructor(t){I(this,Y);n(this,"forward");n(this,"reverse");n(this,"left");n(this,"right");switch(this.forward=0,this.reverse=0,this.right=0,this.left=0,t){case"KEYS":y(this,Y,X).call(this);break;case"DUMMY":this.forward=1;break}}}Y=new WeakSet,X=function(){document.onkeydown=t=>{switch(t.key){case"ArrowUp":this.forward=1;break;case"ArrowDown":this.reverse=1;break;case"ArrowLeft":this.left=1;break;case"ArrowRight":this.right=1;break}},document.onkeyup=t=>{switch(t.key){case"ArrowUp":this.forward=0;break;case"ArrowDown":this.reverse=0;break;case"ArrowLeft":this.left=0;break;case"ArrowRight":this.right=0;break}}};function M(i,t,e){return i+(t-i)*e}function W(i,t,e,s){const h=(s.x-e.x)*(i.y-e.y)-(s.y-e.y)*(i.x-e.x),a=(e.y-i.y)*(i.x-t.x)-(e.x-i.x)*(i.y-t.y),o=(s.y-e.y)*(t.x-i.x)-(s.x-e.x)*(t.y-i.y);if(o!=0){const r=h/o,f=a/o;if(r>=0&&r<=1&&f>=0&&f<=1)return{x:M(i.x,t.x,r),y:M(i.y,t.y,r),offset:r}}return null}function q(i,t){for(let e=0;e<i.length;e++)for(let s=0;s<t.length;s++)if(W(i[e],i[(e+1)%i.length],t[s],t[(s+1)%t.length]))return!0;return!1}function R(i){const t=Math.abs(i),e=i<0?0:255,s=e,h=i>0?0:255;return"rgba("+e+","+s+","+h+","+t+")"}class j{constructor(t){n(this,"levels");this.levels=[];for(let e=0;e<t.length-1;e++)this.levels.push(new U(t[e],t[e+1]))}static feedForward(t,e){let s=U.feedForward(t,e.levels[0]);for(let h=1;h<e.levels.length;h++)s=U.feedForward(s,e.levels[h]);return s}static mutate(t,e=1){t.levels.forEach(s=>{for(let h=0;h<s.biases.length;h++)s.biases[h]=M(s.biases[h],Math.random()*2-1,e);for(let h=0;h<s.weights.length;h++)for(let a=0;a<s.weights[h].length;a++)s.weights[h][a]=M(s.weights[h][a],Math.random()*2-1,e)})}}var E,Q;const N=class N{constructor(t,e){n(this,"inputs");n(this,"outputs");n(this,"biases");n(this,"weights");var s;this.inputs=new Array(t),this.outputs=new Array(e),this.biases=new Array(e),this.weights=new Array(t);for(let h=0;h<t;h++)this.weights[h]=new Array(e);y(s=N,E,Q).call(s,this)}static feedForward(t,e){for(let s=0;s<e.inputs.length;s++)e.inputs[s]=t[s];for(let s=0;s<e.outputs.length;s++){let h=0;for(let a=0;a<e.inputs.length;a++)h+=e.inputs[a]*e.weights[a][s];h>e.biases[s]?e.outputs[s]=1:e.outputs[s]=0}return e.outputs}};E=new WeakSet,Q=function(t){for(let e=0;e<t.inputs.length;e++)for(let s=0;s<t.outputs.length;s++)t.weights[e][s]=Math.random()*2-1;for(let e=0;e<t.biases.length;e++)t.biases[e]=Math.random()*2-1},I(N,E);let U=N;var L,Z,$;class nt{constructor(t){I(this,L);n(this,"car");n(this,"rayCount");n(this,"rayLenght");n(this,"raySpread");n(this,"rays");n(this,"readings");this.car=t,this.rayCount=5,this.rayLenght=150,this.raySpread=Math.PI/2,this.rays=[],this.readings=[]}update(t,e){y(this,L,$).call(this),this.readings=[];for(let s=0;s<this.rayCount;s++)this.readings.push(y(this,L,Z).call(this,this.rays[s],t,e))}draw(t){for(let e=0;e<this.rayCount;e++){let s=this.rays[e][1];this.readings[e]&&(s=this.readings[e]),t.beginPath(),t.lineWidth=2,t.strokeStyle="yellow",t.moveTo(this.rays[e][0].x,this.rays[e][0].y),t.lineTo(s.x,s.y),t.stroke(),t.beginPath(),t.lineWidth=2,t.strokeStyle="black",t.moveTo(this.rays[e][1].x,this.rays[e][1].y),t.lineTo(s.x,s.y),t.stroke()}}}L=new WeakSet,Z=function(t,e,s){let h=[];for(let a=0;a<e.length;a++){const o=W(t[0],t[1],e[a][0],e[a][1]);o&&h.push(o)}for(let a=0;a<s.length;a++)for(let o=0;o<s[a].polygon.length;o++){const r=W(t[0],t[1],s[a].polygon[o],s[a].polygon[(o+1)%s[a].polygon.length]);r&&h.push(r)}if(h.length==0)return null;{const a=h.map(r=>r.offset),o=Math.min(...a);return h.find(r=>r.offset==o)||null}},$=function(){this.rays=[];for(let t=0;t<this.rayCount;t++){const e=M(this.raySpread/2,-this.raySpread/2,this.rayCount==1?.5:t/(this.rayCount-1))+this.car.angle,s={x:this.car.x,y:this.car.y},h={x:this.car.x-Math.sin(e)*this.rayLenght,y:this.car.y-Math.cos(e)*this.rayLenght};this.rays.push([s,h])}};var C,z,V;class m{constructor(t,e,s,h,a,o=2,r="blue"){I(this,C);n(this,"x");n(this,"y");n(this,"width");n(this,"height");n(this,"speed");n(this,"acceleration");n(this,"friction");n(this,"angle");n(this,"maxSpeed");n(this,"controls");n(this,"sensor",null);n(this,"polygon");n(this,"damaged");n(this,"brain",null);n(this,"useBrain");n(this,"img");n(this,"mask");this.x=t,this.y=e,this.width=s,this.height=h,this.speed=0,this.acceleration=.2,this.maxSpeed=o,this.friction=.05,this.angle=0,this.polygon=[],this.damaged=!1,this.controls=new ht(a),this.useBrain=a=="AI",this.mask=document.createElement("canvas"),this.mask.width=s,this.mask.height=h,this.img=new Image,this.img.src="car.png",this.img.onload=()=>{this.setupMask(r)},this.img.onerror=()=>{console.error("Erreur de chargement de l'image:",this.img.src)},a!="DUMMY"&&(this.sensor=new nt(this),this.brain=new j([this.sensor.rayCount,6,4])),this.polygon=this.createPolygon()}setupMask(t){const e=this.mask.getContext("2d");e&&(e.fillStyle=t,e.rect(0,0,this.width,this.height),e.fill(),e.globalCompositeOperation="destination-atop",e.drawImage(this.img,0,0,this.width,this.height))}createPolygon(){const t=[],e=Math.hypot(this.width,this.height)/2,s=Math.atan2(this.width,this.height);return t.push({x:this.x-Math.sin(this.angle-s)*e,y:this.y-Math.cos(this.angle-s)*e}),t.push({x:this.x-Math.sin(this.angle+s)*e,y:this.y-Math.cos(this.angle+s)*e}),t.push({x:this.x-Math.sin(Math.PI+this.angle-s)*e,y:this.y-Math.cos(Math.PI+this.angle-s)*e}),t.push({x:this.x-Math.sin(Math.PI+this.angle+s)*e,y:this.y-Math.cos(Math.PI+this.angle+s)*e}),t}update(t,e){if(this.damaged||(y(this,C,V).call(this),this.polygon=this.createPolygon(),this.damaged=y(this,C,z).call(this,t,e)),this.sensor){this.sensor.update(t,e);const s=this.sensor.readings.map(a=>a==null?0:1-a.offset),h=j.feedForward(s,this.brain);this.useBrain&&(this.controls.forward=h[0],this.controls.left=h[1],this.controls.right=h[2],this.controls.reverse=h[3])}}draw(t,e=!1){this.sensor&&e&&this.sensor.draw(t),t.save(),t.translate(this.x,this.y),t.rotate(-this.angle),this.damaged||(t.drawImage(this.mask,-this.width/2,-this.height/2,this.width,this.height),t.globalCompositeOperation="multiply"),t.drawImage(this.img,-this.width/2,-this.height/2,this.width,this.height),t.restore()}}C=new WeakSet,z=function(t,e){for(let s=0;s<t.length;s++)if(q(this.polygon,t[s]))return!0;for(let s=0;s<e.length;s++)if(q(this.polygon,e[s].polygon))return!0;return!1},V=function(){if(this.controls.forward&&(this.speed+=this.acceleration),this.controls.reverse&&(this.speed-=this.acceleration),this.speed>this.maxSpeed&&(this.speed=this.maxSpeed),this.speed<-this.maxSpeed/2&&(this.speed=-this.maxSpeed/2),this.speed>0&&(this.speed-=this.friction),this.speed<0&&(this.speed+=this.friction),Math.abs(this.speed)<this.friction&&(this.speed=0),this.speed!=0){const t=this.speed>0?1:-1;this.controls.left&&(this.angle+=.03*t),this.controls.right&&(this.angle-=.03*t)}this.x-=Math.sin(this.angle)*this.speed,this.y-=Math.cos(this.angle)*this.speed};class at{constructor(t,e,s=4){n(this,"x");n(this,"width");n(this,"laneCount");n(this,"left");n(this,"right");n(this,"top");n(this,"bottom");n(this,"borders");this.x=t,this.width=e,this.laneCount=s,this.left=t-e/2,this.right=t+e/2;const h=1e6;this.top=-1e6,this.bottom=h;const a={x:this.left,y:this.top},o={x:this.right,y:this.top},r={x:this.left,y:this.bottom},f={x:this.right,y:this.bottom};this.borders=[[a,r],[o,f]]}getLaneCenter(t){const e=this.width/this.laneCount;return this.left+e/2+Math.min(t,this.laneCount-1)*e}draw(t){t.lineWidth=5,t.strokeStyle="white";for(let e=1;e<=this.laneCount-1;e++){const s=M(this.left,this.right,e/this.laneCount);t.setLineDash([20,20]),t.beginPath(),t.moveTo(s,this.top),t.lineTo(s,this.bottom),t.stroke()}t.setLineDash([]),this.borders.forEach(e=>{t.beginPath(),t.moveTo(e[0].x,e[0].y),t.lineTo(e[1].x,e[1].y),t.stroke()})}}var S,T;const b=class b{static drawNetwork(t,e){const o=t.canvas.width-100,r=t.canvas.height-50*2,f=r/e.levels.length;for(let w=e.levels.length-1;w>=0;w--){const k=50+M(r-f,0,e.levels.length==1?.5:w/(e.levels.length-1));t.setLineDash([7,3]),b.drawLevel(t,e.levels[w],50,k,o,f,w==e.levels.length-1?["ðŸ ‰","ðŸ ˆ","ðŸ Š","ðŸ ‹"]:[])}}static drawLevel(t,e,s,h,a,o,r){var B,H,G,J;const f=s+a,w=h+o,{inputs:k,outputs:v,weights:x,biases:tt}=e;for(let l=0;l<k.length;l++)for(let d=0;d<v.length;d++)t.beginPath(),t.moveTo(y(B=b,S,T).call(B,k,l,s,f),w),t.lineTo(y(H=b,S,T).call(H,v,d,s,f),h),t.lineWidth=2,t.strokeStyle=R(x[l][d]),t.stroke();const p=18;for(let l=0;l<k.length;l++){const d=y(G=b,S,T).call(G,k,l,s,f);t.beginPath(),t.arc(d,w,p,0,Math.PI*2),t.fillStyle="black",t.fill(),t.beginPath(),t.arc(d,w,p*.6,0,Math.PI*2),t.fillStyle=R(k[l]),t.fill()}for(let l=0;l<v.length;l++){const d=y(J=b,S,T).call(J,v,l,s,f);t.beginPath(),t.arc(d,h,p,0,Math.PI*2),t.fillStyle="black",t.fill(),t.beginPath(),t.arc(d,h,p*.6,0,Math.PI*2),t.fillStyle=R(v[l]),t.fill(),t.beginPath(),t.lineWidth=2,t.arc(d,h,p*.8,0,Math.PI*2),t.strokeStyle=R(tt[l]),t.setLineDash([3,3]),t.stroke(),t.setLineDash([]),r[l]&&(t.beginPath(),t.textAlign="center",t.textBaseline="middle",t.fillStyle="black",t.strokeStyle="white",t.font=p*1.5+"px Arial",t.fillText(r[l],d,h+p*.1),t.lineWidth=.5,t.strokeText(r[l],d,h+p*.1))}}};S=new WeakSet,T=function(t,e,s,h){return M(s,h,t.length==1?.5:e/(t.length-1))},I(b,S);let F=b;const P=document.getElementById("carCanvas"),O=document.getElementById("networkCanvas"),g=P.getContext("2d"),rt=O.getContext("2d");P.width=200;O.width=300;const c=new at(P.width/2,P.width*.9,3),ot=1e3,u=dt(ot),D=[new m(c.getLaneCenter(1),-100,30,50,"DUMMY",2,"red"),new m(c.getLaneCenter(0),-300,30,50,"DUMMY",2,"red"),new m(c.getLaneCenter(2),-300,30,50,"DUMMY",2,"red"),new m(c.getLaneCenter(0),-500,30,50,"DUMMY",2,"red"),new m(c.getLaneCenter(1),-500,30,50,"DUMMY",2,"red"),new m(c.getLaneCenter(1),-700,30,50,"DUMMY",2,"red"),new m(c.getLaneCenter(2),-700,30,50,"DUMMY",2,"red")];let A=u[0];if(localStorage.getItem("bestBrain")){console.log("hghh");for(let i=0;i<u.length;i++)u[i].brain=JSON.parse(localStorage.getItem("bestBrain")),i!=0&&j.mutate(u[i].brain,.1)}_();function lt(){localStorage.setItem("bestBrain",JSON.stringify(A.brain))}function gt(){localStorage.removeItem("bestBrain")}window.save=lt;window.discard=gt;function dt(i){const t=[];for(;i>0;)t.push(new m(c.getLaneCenter(1),100,30,50,"AI",4)),i--;return t}function _(){for(let i=0;i<D.length;i++)D[i].update(c.borders,[]);for(let i=0;i<u.length;i++)u[i].update(c.borders,D);A=u.find(i=>i.y==Math.min(...u.map(t=>t.y))),P.height=window.innerHeight,O.height=window.innerHeight,g==null||g.save(),g==null||g.translate(0,-A.y+P.height*.7),c.draw(g);for(let i=0;i<D.length;i++)D[i].draw(g);g.globalAlpha=.2;for(let i=0;i<u.length;i++)u[i].draw(g);g.globalAlpha=1,A.draw(g,!0),g==null||g.restore(),F.drawNetwork(rt,A.brain),requestAnimationFrame(_)}
